apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "zeroclaw.fullname" . }}-config
  labels:
    {{- include "zeroclaw.labels" . | nindent 4 }}
data:
  config.toml: |
    # Generated by Helm — do not edit manually.
    workspace_dir = "/zeroclaw-data/workspace"
    config_path = "/zeroclaw-data/.zeroclaw/config.toml"
    default_provider = {{ .Values.config.provider | quote }}
    {{- if .Values.config.model }}
    default_model = {{ .Values.config.model | quote }}
    {{- else }}
    default_model = "claude-sonnet-4-5-20250929"
    {{- end }}
    default_temperature = {{ .Values.config.temperature }}

    # ── Gateway ───────────────────────────────────────────────
    [gateway]
    port = {{ .Values.service.targetPort }}
    host = "[::]"
    allow_public_bind = {{ .Values.config.allowPublicBind }}
    require_pairing = {{ .Values.config.requirePairing }}
    pair_rate_limit_per_minute = {{ .Values.config.gateway.pairRateLimitPerMinute }}
    webhook_rate_limit_per_minute = {{ .Values.config.gateway.webhookRateLimitPerMinute }}
    idempotency_ttl_secs = {{ .Values.config.gateway.idempotencyTtlSecs }}

    # ── Memory ────────────────────────────────────────────────
    [memory]
    backend = {{ .Values.config.memory.backend | quote }}
    auto_save = {{ .Values.config.memory.autoSave }}
    embedding_provider = {{ .Values.config.memory.embeddingProvider | quote }}
    embedding_model = {{ .Values.config.memory.embeddingModel | quote }}
    embedding_dimensions = {{ .Values.config.memory.embeddingDimensions }}
    vector_weight = {{ .Values.config.memory.vectorWeight }}
    keyword_weight = {{ .Values.config.memory.keywordWeight }}
    embedding_cache_size = {{ .Values.config.memory.embeddingCacheSize }}
    chunk_max_tokens = {{ .Values.config.memory.chunkMaxTokens }}
    hygiene_enabled = {{ .Values.config.memory.hygieneEnabled }}
    archive_after_days = {{ .Values.config.memory.archiveAfterDays }}
    purge_after_days = {{ .Values.config.memory.purgeAfterDays }}
    conversation_retention_days = {{ .Values.config.memory.conversationRetentionDays }}
    response_cache_enabled = {{ .Values.config.memory.responseCacheEnabled }}
    response_cache_ttl_minutes = {{ .Values.config.memory.responseCacheTtlMinutes }}
    response_cache_max_entries = {{ .Values.config.memory.responseCacheMaxEntries }}
    snapshot_enabled = {{ .Values.config.memory.snapshotEnabled }}
    snapshot_on_hygiene = {{ .Values.config.memory.snapshotOnHygiene }}
    auto_hydrate = {{ .Values.config.memory.autoHydrate }}

    # ── Autonomy / Security ──────────────────────────────────
    [autonomy]
    level = {{ .Values.config.autonomy.level | quote }}
    workspace_only = {{ .Values.config.autonomy.workspaceOnly }}
    allowed_commands = {{ include "zeroclaw.tomlStringList" .Values.config.autonomy.allowedCommands }}
    forbidden_paths = {{ include "zeroclaw.tomlStringList" .Values.config.autonomy.forbiddenPaths }}
    max_actions_per_hour = {{ .Values.config.autonomy.maxActionsPerHour }}
    max_cost_per_day_cents = {{ .Values.config.autonomy.maxCostPerDayCents }}
    require_approval_for_medium_risk = {{ .Values.config.autonomy.requireApprovalForMediumRisk }}
    block_high_risk_commands = {{ .Values.config.autonomy.blockHighRiskCommands }}

    # ── Runtime ───────────────────────────────────────────────
    [runtime]
    kind = {{ .Values.config.runtime.kind | quote }}

    [runtime.docker]
    image = {{ .Values.config.runtime.docker.image | quote }}
    network = {{ .Values.config.runtime.docker.network | quote }}
    memory_limit_mb = {{ .Values.config.runtime.docker.memoryLimitMb }}
    cpu_limit = {{ .Values.config.runtime.docker.cpuLimit }}
    read_only_rootfs = {{ .Values.config.runtime.docker.readOnlyRootfs }}
    mount_workspace = {{ .Values.config.runtime.docker.mountWorkspace }}
    {{- if .Values.config.runtime.docker.allowedWorkspaceRoots }}
    allowed_workspace_roots = {{ include "zeroclaw.tomlStringList" .Values.config.runtime.docker.allowedWorkspaceRoots }}
    {{- else }}
    allowed_workspace_roots = []
    {{- end }}

    # ── Heartbeat ─────────────────────────────────────────────
    [heartbeat]
    enabled = {{ .Values.config.heartbeat.enabled }}
    interval_minutes = {{ .Values.config.heartbeat.intervalMinutes }}

    # ── Tunnel ────────────────────────────────────────────────
    [tunnel]
    provider = {{ .Values.config.tunnel.provider | quote }}

    # ── Secrets ───────────────────────────────────────────────
    [secrets]
    encrypt = {{ .Values.config.secretsEncrypt }}

    # ── Browser ───────────────────────────────────────────────
    [browser]
    enabled = {{ .Values.config.browser.enabled }}
    {{- if .Values.config.browser.allowedDomains }}
    allowed_domains = {{ include "zeroclaw.tomlStringList" .Values.config.browser.allowedDomains }}
    {{- else }}
    allowed_domains = []
    {{- end }}
    backend = {{ .Values.config.browser.backend | quote }}
    native_headless = {{ .Values.config.browser.nativeHeadless }}
    native_webdriver_url = {{ .Values.config.browser.nativeWebdriverUrl | quote }}

    # ── Composio ──────────────────────────────────────────────
    [composio]
    enabled = {{ .Values.config.composio.enabled }}
    entity_id = {{ .Values.config.composio.entityId | quote }}
    {{- if and .Values.config.composio.enabled (include "zeroclaw.hasChannelSecrets" .) }}
    api_key = "__SECRET_COMPOSIO_API_KEY__"
    {{- end }}

    # ── Identity ──────────────────────────────────────────────
    [identity]
    format = {{ .Values.config.identity.format | quote }}
    {{- if .Values.config.identity.aieosPath }}
    aieos_path = {{ .Values.config.identity.aieosPath | quote }}
    {{- end }}
    {{- if .Values.config.identity.aieosInline }}
    aieos_inline = {{ .Values.config.identity.aieosInline | squote }}
    {{- end }}

    # ── Observability ─────────────────────────────────────────
    [observability]
    backend = {{ .Values.config.observability.backend | quote }}
    {{- if .Values.config.observability.otelEndpoint }}
    otel_endpoint = {{ .Values.config.observability.otelEndpoint | quote }}
    {{- end }}
    {{- if .Values.config.observability.otelServiceName }}
    otel_service_name = {{ .Values.config.observability.otelServiceName | quote }}
    {{- end }}

    # ── Agent ─────────────────────────────────────────────────
    [agent]
    compact_context = {{ .Values.config.agent.compactContext }}
    max_tool_iterations = {{ .Values.config.agent.maxToolIterations }}
    max_history_messages = {{ .Values.config.agent.maxHistoryMessages }}
    parallel_tools = {{ .Values.config.agent.parallelTools }}
    tool_dispatcher = {{ .Values.config.agent.toolDispatcher | quote }}

    # ── Reliability ───────────────────────────────────────────
    [reliability]
    provider_retries = {{ .Values.config.reliability.providerRetries }}
    provider_backoff_ms = {{ .Values.config.reliability.providerBackoffMs }}
    {{- if .Values.config.reliability.fallbackProviders }}
    fallback_providers = {{ include "zeroclaw.tomlStringList" .Values.config.reliability.fallbackProviders }}
    {{- else }}
    fallback_providers = []
    {{- end }}
    channel_initial_backoff_secs = {{ .Values.config.reliability.channelInitialBackoffSecs }}
    channel_max_backoff_secs = {{ .Values.config.reliability.channelMaxBackoffSecs }}

    # ── Scheduler ─────────────────────────────────────────────
    [scheduler]
    enabled = {{ .Values.config.scheduler.enabled }}
    max_tasks = {{ .Values.config.scheduler.maxTasks }}
    max_concurrent = {{ .Values.config.scheduler.maxConcurrent }}

    # ── Cost tracking ─────────────────────────────────────────
    [cost]
    enabled = {{ .Values.config.cost.enabled }}
    daily_limit_usd = {{ .Values.config.cost.dailyLimitUsd }}
    monthly_limit_usd = {{ .Values.config.cost.monthlyLimitUsd }}
    warn_at_percent = {{ .Values.config.cost.warnAtPercent }}

    # ── Channels ──────────────────────────────────────────────
    [channels_config]
    cli = true

    {{- if .Values.config.channels.telegram.enabled }}

    [channels_config.telegram]
    bot_token = "__SECRET_TELEGRAM_BOT_TOKEN__"
    allowed_users = {{ include "zeroclaw.tomlStringList" .Values.config.channels.telegram.allowedUsers }}
    {{- end }}

    {{- if .Values.config.channels.discord.enabled }}

    [channels_config.discord]
    bot_token = "__SECRET_DISCORD_BOT_TOKEN__"
    {{- if .Values.config.channels.discord.guildId }}
    guild_id = {{ .Values.config.channels.discord.guildId | quote }}
    {{- end }}
    allowed_users = {{ include "zeroclaw.tomlStringList" .Values.config.channels.discord.allowedUsers }}
    listen_to_bots = {{ .Values.config.channels.discord.listenToBots }}
    {{- end }}

    {{- if .Values.config.channels.slack.enabled }}

    [channels_config.slack]
    bot_token = "__SECRET_SLACK_BOT_TOKEN__"
    {{- if .Values.config.channels.slack.channelId }}
    channel_id = {{ .Values.config.channels.slack.channelId | quote }}
    {{- end }}
    allowed_users = {{ include "zeroclaw.tomlStringList" .Values.config.channels.slack.allowedUsers }}
    {{- end }}

    {{- if .Values.config.channels.whatsapp.enabled }}

    [channels_config.whatsapp]
    access_token = "__SECRET_WHATSAPP_ACCESS_TOKEN__"
    phone_number_id = {{ .Values.config.channels.whatsapp.phoneNumberId | quote }}
    verify_token = "__SECRET_WHATSAPP_VERIFY_TOKEN__"
    allowed_numbers = {{ include "zeroclaw.tomlStringList" .Values.config.channels.whatsapp.allowedNumbers }}
    {{- end }}

    {{- if .Values.config.channels.matrix.enabled }}

    [channels_config.matrix]
    homeserver = {{ .Values.config.channels.matrix.homeserver | quote }}
    access_token = "__SECRET_MATRIX_ACCESS_TOKEN__"
    room_id = {{ .Values.config.channels.matrix.roomId | quote }}
    allowed_users = {{ include "zeroclaw.tomlStringList" .Values.config.channels.matrix.allowedUsers }}
    {{- end }}

    {{- if .Values.config.channels.imessage.enabled }}

    [channels_config.imessage]
    allowed_contacts = {{ include "zeroclaw.tomlStringList" .Values.config.channels.imessage.allowedContacts }}
    {{- end }}

    {{- if .Values.config.channels.irc.enabled }}

    [channels_config.irc]
    server = {{ .Values.config.channels.irc.server | quote }}
    port = {{ .Values.config.channels.irc.port }}
    nickname = {{ .Values.config.channels.irc.nickname | quote }}
    {{- if .Values.config.channels.irc.username }}
    username = {{ .Values.config.channels.irc.username | quote }}
    {{- end }}
    channels = {{ include "zeroclaw.tomlStringList" .Values.config.channels.irc.channels }}
    allowed_users = {{ include "zeroclaw.tomlStringList" .Values.config.channels.irc.allowedUsers }}
    server_password = "__SECRET_IRC_SERVER_PASSWORD__"
    nickserv_password = "__SECRET_IRC_NICKSERV_PASSWORD__"
    sasl_password = "__SECRET_IRC_SASL_PASSWORD__"
    verify_tls = {{ .Values.config.channels.irc.verifyTls }}
    {{- end }}

    {{- if .Values.config.channels.lark.enabled }}

    [channels_config.lark]
    app_id = {{ .Values.config.channels.lark.appId | quote }}
    app_secret = "__SECRET_LARK_APP_SECRET__"
    {{- if .Values.config.channels.lark.encryptKey }}
    encrypt_key = {{ .Values.config.channels.lark.encryptKey | quote }}
    {{- end }}
    {{- if .Values.config.channels.lark.verificationToken }}
    verification_token = {{ .Values.config.channels.lark.verificationToken | quote }}
    {{- end }}
    allowed_users = {{ include "zeroclaw.tomlStringList" .Values.config.channels.lark.allowedUsers }}
    use_feishu = {{ .Values.config.channels.lark.useFeishu }}
    {{- end }}

    {{- if .Values.config.channels.dingtalk.enabled }}

    [channels_config.dingtalk]
    client_id = {{ .Values.config.channels.dingtalk.clientId | quote }}
    client_secret = "__SECRET_DINGTALK_CLIENT_SECRET__"
    allowed_users = {{ include "zeroclaw.tomlStringList" .Values.config.channels.dingtalk.allowedUsers }}
    {{- end }}

    {{- if .Values.config.extraConfig }}

    # ── Extra configuration ───────────────────────────────────
{{ .Values.config.extraConfig | indent 4 }}
    {{- end }}
{{- range $name, $content := .Values.config.workspaceFiles }}
  {{ $name }}: |
{{ $content | indent 4 }}
{{- end }}
